<script>
  (function() {
    const LOG_ENDPOINT = 'https://8hrwthhcbc.execute-api.ap-northeast-2.amazonaws.com/ingest';

    // â€”â€”â€”â€” ìœ í‹¸ë¦¬í‹°: ë¡œê·¸ ì „ì†¡ í•¨ìˆ˜ â€”â€”â€”â€”
    function sendLog(eventType, extra = {}) {
      const utm = JSON.parse(sessionStorage.getItem('utm') || '{}');
      const payload = {
        event: eventType,
        timestamp: new Date().toISOString(),
        path: window.location.pathname,
        referrer: document.referrer || null,
        ...utm,
        ...extra
      };
      // ì–¸ë¡œë“œ ì‹œ ì„¸ì…˜ ì¢…ë£Œë§Œ sendBeacon ì‚¬ìš©
      if (eventType === 'session_end' && navigator.sendBeacon) {
        navigator.sendBeacon(LOG_ENDPOINT, JSON.stringify(payload));
      } else {
        fetch(LOG_ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
          keepalive: true
        }).catch(err => console.error('Ingest error:', err));
      }
    }

    // â€”â€”â€”â€” 1) UTM/Referrer ì €ìž¥ & referral_event â€”â€”â€”â€”
    window.addEventListener('load', () => {
      // UTM ì¶”ì¶œ
      const params = new URLSearchParams(location.search);
      const utm = {
        utm_source: params.get('utm_source'),
        utm_medium: params.get('utm_medium'),
        utm_campaign: params.get('utm_campaign')
      };
      if (utm.utm_source) {
        sessionStorage.setItem('utm', JSON.stringify(utm));
        sendLog('referral_event', {});  
      }
      // ì„¸ì…˜ ì‹œìž‘ & íŽ˜ì´ì§€ë·°
      sendLog('session_start', { user_agent: navigator.userAgent });
      sendLog('page_view', {});
    });

    // â€”â€”â€”â€” 2) ì²´ë¥˜ ì‹œê°„ & ì„¸ì…˜ ì¢…ë£Œ â€”â€”â€”â€”
    const __startTime = Date.now();
    window.addEventListener('beforeunload', () => {
      sendLog('time_on_page', { duration: Date.now() - __startTime });
      sendLog('session_end', {});
    });

    // â€”â€”â€”â€” 3) ìŠ¤í¬ë¡¤ ê¹Šì´ ë¡œê¹… â€”â€”â€”â€”
    let __lastScroll = 0;
    window.addEventListener('scroll', () => {
      const now = Date.now();
      if (now - __lastScroll < 1000) return;
      __lastScroll = now;
      const pct = Math.round((window.scrollY / (document.body.scrollHeight - window.innerHeight)) * 100);
      sendLog('scroll_event', { scroll_percentage: pct });
    });

    // â€”â€”â€”â€” 4) í´ë¦­ ì´ë²¤íŠ¸ ë¡œê¹… â€”â€”â€”â€”
    document.addEventListener('click', e => {
      const tgt = e.target.closest('[data-log-click]') || e.target;
      // ðŸ‘‡ í´ë¦­ ë¡œê·¸ë¥¼ ì½˜ì†”ì—ë„ ì¶œë ¥
      console.log('click_event:', { tag: tgt.tagName, id: tgt.id || null, x: e.clientX, y: e.clientY });
      sendLog('click_event', {
        tag: tgt.tagName,
        id: tgt.id || null,
        x: e.clientX,
        y: e.clientY
      });
    });

    // â€”â€”â€”â€” 5) ë‚´ë¶€ ë‚´ë¹„ê²Œì´ì…˜ â€”â€”â€”â€”
    document.querySelectorAll('a[href^="/"]').forEach(a => {
      a.addEventListener('click', () => {
        sendLog('navigation', {
          from: window.location.pathname,
          to: new URL(a.href).pathname
        });
      });
    });

    // â€”â€”â€”â€” 6) ê¸°íƒ€ ì¸í„°ëž™ì…˜ â€”â€”â€”â€”
    // ê³µìœ  ë²„íŠ¼
    document.querySelectorAll('[data-log-share]').forEach(btn => {
      btn.addEventListener('click', () => {
        sendLog('share_event', { platform: btn.dataset.platform || null });
      });
    });
    // ëŒ“ê¸€ í¼
    const commentForm = document.getElementById('comment-form');
    if (commentForm) {
      commentForm.addEventListener('submit', () => {
        sendLog('comment_submit', { post_id: commentForm.dataset.postId });
      });
    }
    // ë°”ìš´ìŠ¤ ì •ì˜: 5ì´ˆ ë‚´ ìƒí˜¸ìž‘ìš© ì—†ìœ¼ë©´
    let __interacted = false;
    ['click','scroll','keydown'].forEach(evt => 
      document.addEventListener(evt, () => { __interacted = true; })
    );
    setTimeout(() => {
      if (!__interacted) sendLog('bounce_event', {});
    }, 5000);

  })();
</script>